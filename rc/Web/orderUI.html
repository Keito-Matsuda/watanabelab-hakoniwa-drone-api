<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order Drone Delivery</title>
  <style>
    :root {
      --bg: #f7f7f8;
      --card: #fff;
      --text: #111827;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --border: #e5e7eb;
      --danger: #ef4444;
      --ok: #16a34a;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; color: var(--text); background: var(--bg); }
    .container { max-width: 1120px; margin: 0 auto; padding: 16px; }

    /* Header */
    header { position: sticky; top: 0; z-index: 40; backdrop-filter: blur(6px); background: rgba(255,255,255,0.8); border-bottom: 1px solid var(--border); }
    header .inner { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 12px 16px; max-width: 1120px; margin: 0 auto; }
    .brand { font-weight: 700; font-size: 18px; }
    .search { flex: 1; display: flex; justify-content: flex-end; gap: 8px; }
    .search input { width: 100%; max-width: 520px; border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; outline: none; }
    .btn { border: 1px solid var(--border); background: #fff; color: var(--text); border-radius: 12px; padding: 10px 14px; cursor: pointer; }
    .btn:hover { background: #f9fafb; }
    .btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btn.primary:hover { background: var(--primary-hover); }
    .badge { position: absolute; right: -8px; top: -8px; background: var(--primary); color: #fff; border-radius: 999px; padding: 2px 6px; font-size: 12px; font-weight: 700; }

    /* Tabs */
    .tabs { display: flex; gap: 8px; overflow-x: auto; padding: 8px 0; }
    .tab { border: 0; background: #eef2ff; color: #374151; border-radius: 999px; padding: 8px 12px; cursor: pointer; font-size: 14px; }
    .tab.active { background: #111827; color: #fff; }

    /* Coords */
    .coords { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .coord { display: flex; align-items: center; gap: 8px; background: var(--card); padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; }
    .coord span { width: 16px; color: var(--muted); font-size: 14px; }
    .coord input { flex: 1; border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; }
    @media (max-width: 640px) { .coords { grid-template-columns: 1fr; } }

    /* Drone status */
    .status { display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--border); background: var(--card); border-radius: 16px; padding: 12px; margin: 12px 0 1cm;  }
    .dot { width: 8px; height: 8px; border-radius: 999px; margin-right: 6px; display: inline-block; background: #9ca3af; }
    .dot.ok { background: var(--ok); }
    .status .right span { color: var(--muted); font-size: 14px; }
    .status .right b { color: var(--text); }

    /* Menu grid */
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding-bottom: 96px; }
    @media (max-width: 960px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } }

    .card { overflow: hidden; border: 1px solid var(--border); border-radius: 20px; background: var(--card); box-shadow: 0 1px 2px rgb(0 0 0 / 0.04); display: flex; flex-direction: column; }
    .card .image { position: relative; width: 100%; padding-top: 75%; overflow: hidden; }
    .card img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; transition: transform .3s; }
    .card:hover img { transform: scale(1.05); }
    .card .body { padding: 12px; display: grid; gap: 6px; }
    .card .title { font-weight: 700; }
    .muted { color: var(--muted); font-size: 14px; }

    /* Floating cart button */
    #float-cart { position: fixed; right: 24px; bottom: 24px; z-index: 30; border-radius: 999px; padding: 12px 16px; box-shadow: 0 8px 24px rgba(0,0,0,.12); }

    /* Drawer */
    .drawer-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.4); opacity: 0; pointer-events: none; transition: opacity .2s; }
    .drawer { position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 420px; background: #fff; transform: translateX(100%); transition: transform .25s; box-shadow: -8px 0 24px rgba(0,0,0,.1); display: flex; flex-direction: column; }
    .drawer.open { transform: translateX(0); }
    .drawer-backdrop.open { opacity: 1; pointer-events: auto; }
    .drawer .head { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border); }
    .drawer .content { padding: 12px; overflow: auto; flex: 1; }
    .drawer .foot { padding: 12px; border-top: 1px solid var(--border); }
    .cart-item { display: flex; gap: 12px; }
    .cart-item img { width: 64px; height: 64px; object-fit: cover; border-radius: 10px; }
    .qty { display: inline-flex; align-items: center; gap: 8px; }
    .qty button { width: 28px; height: 28px; border-radius: 8px; border: 1px solid var(--border); background: #fff; cursor: pointer; }
    .remove { color: var(--danger); background: transparent; border: 0; cursor: pointer; }
    .subtotal { display: flex; align-items: center; justify-content: space-between; font-weight: 700; margin-bottom: 8px; }

    /* Toasts */
    #toasts { position: fixed; right: 16px; top: 16px; z-index: 60; display: grid; gap: 8px; }
    .toast { background: rgba(0,0,0,.85); color: #fff; padding: 10px 12px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.18); }

    .dest { display: flex; align-items: center; gap: 12px; }
    .dest-select { border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; background: #fff; }
    .dest-preview { font-size: 14px; }
    #dest-preview { display: none; }
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <div class="brand">Order Drone Delivery</div>
      <div class="search">
        <input id="search" type="text" placeholder="商品を検索…" aria-label="商品検索" />
        <button id="open-cart" class="btn" aria-label="カートを開く" style="position:relative">
          カート
          <span id="cart-badge" class="badge" hidden>0</span>
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="tabs" role="tablist" aria-label="カテゴリ">
      <button class="tab active" data-cat="all" role="tab" aria-selected="true">すべて</button>
      <button class="tab" data-cat="western" role="tab" aria-selected="false">洋食</button>
      <button class="tab" data-cat="japanese" role="tab" aria-selected="false">和食</button>
      <button class="tab" data-cat="chinese" role="tab" aria-selected="false">中華</button>
    </div>

    <!-- <div style="margin:8px 0 4px; font-weight:600; color:#374151">配達座標</div>
    <div class="coords" aria-label="配達座標入力">
      <label class="coord"><span>X</span><input id="coord-x" type="number" step="0.1" value="10" /></label>
      <label class="coord"><span>Y</span><input id="coord-y" type="number" step="0.1" value="10" /></label>
      <label class="coord"><span>Z</span><input id="coord-z" type="number" step="0.1" value="0.5" /></label>
    </div> -->

    <div style="margin:8px 0 4px; font-weight:600; color:#374151">お届け先</div>
    <div class="dest" aria-label="お届け先選択">
      <select id="destination" class="dest-select" aria-label="お届け先">
        <option value="8F">8階</option>
        <option value="7F">7階</option>
        <option value="6F">6階</option>
        <option value="5F">5階</option>
        <option value="4F">4階</option>
        <option value="ENTRANCE">エントランス</option>
      </select>
      <div class="dest-preview muted" id="dest-preview"></div>
    </div>

    <div class="status" aria-live="polite">
      <div><span id="conn-dot" class="dot"></span><span id="conn-text" class="muted">Connecting...</span></div>
      <div class="right">
        <span>Drone状態: <b id="st-text">-</b></span>
        <span style="margin-left:12px">ETA: <b id="eta-text">-</b></span>
      </div>
    </div>

    <section id="menu" class="grid" aria-label="メニュー一覧"></section>
  </main>

  <button id="float-cart" class="btn" aria-label="カートを見る">カートを見る</button>

  <!-- Drawer -->
  <div id="drawer-backdrop" class="drawer-backdrop"></div>
  <aside id="drawer" class="drawer" aria-label="カート">
    <div class="head">
      <b>カート</b>
      <button id="close-cart" class="btn">閉じる</button>
    </div>
    <div id="cart-list" class="content"></div>
    <div class="foot">
      <div class="subtotal"><span>小計</span><span id="subtotal">¥0</span></div>
      <button id="checkout" class="btn primary" disabled>注文を確定する</button>
      <div id="order-note" class="muted" style="margin-top:6px; display:none">配達中は次の注文を送信できません。</div>
    </div>
  </aside>

  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script>
    // ---------------------- データ ----------------------
    const ITEMS = [
      { id: 'w1', name: 'ふわとろオムライス', description: '特製デミグラスソースの王道オムライス', price: 500, image: 'images/omelet_rice.png', rating: 4.6, deliveryTime: '10-20分', category: 'western'},
      { id: 'w2', name: '肉厚ハンバーグ弁当', description: 'ジューシーでボリューム満点の手ごねハンバーグ', price: 600, image: 'images/hamburger.png', rating: 4.7, deliveryTime: '15-25分', category: 'western'},
      { id: 'w3', name: 'サクプリエビフライ弁当', description: '外はサクッ、中はプリッ、食感がたまらないシュリンぷり', price: 700, image: 'images/fried_shrimp.png', rating: 5.0, deliveryTime: '15-25分', category: 'western'},
      { id: 'j1', name: '幕の内弁当', description: '塩鮭、煮物、玉子焼き、漬物のバランス和定番', price: 600, image: 'images/makunouchi.png', rating: 4.5, deliveryTime: '10-20分', category: 'japanese'},
      { id: 'j2', name: '豚の生姜焼き弁当', description: '香ばしい生姜だれでジューシーに', price: 500, image: 'images/shogayaki.png', rating: 4.9, deliveryTime: '10-20分', category: 'japanese'},
      { id: 'j3', name: '鯖の味噌煮弁当', description: 'ふっくら鯖を甘めの味噌だれで', price: 700, image: 'images/sabamiso.png', rating: 4.1, deliveryTime: '10-20分', category: 'japanese'},
      { id: 'c1', name: '油淋鶏弁当', description: 'カリッと鶏に香味ねぎソース', price: 700, image: 'images/yu-rinti-.png', rating: 4.5, deliveryTime: '15-25分', category: 'chinese'},
      { id: 'c2', name: '麻婆豆腐弁当', description: '花椒香る痺れとコク', price: 500, image: 'images/ma-bo-.png', rating: 4.0, deliveryTime: '10-20分', category: 'chinese'},
      { id: 'c3', name: '回鍋肉弁当', description: '甘辛みそだれで豚バラとキャベツを炒め合わせ', price: 600, image: 'images/hoiko-ro-.png', rating: 3.9, deliveryTime: '10-20分', category: 'chinese'},
    ];

    // 各お届け先のウェイポイント（例）※値は環境に合わせて調整してちょ
    const WAYPOINTS = {
      '8F':       { x: 10, y: 10, z: 18.0 }, 
      '7F':       { x: 10, y: 10, z: 15.0 },
      '6F':       { x: 10, y: 10, z: 12.0 },
      '5F':       { x: 10, y: 10, z: 9.0  },
      '4F':       { x: 10, y: 10, z: 6.0  },
      'ENTRANCE': { x: 10, y: 10, z: 0.5  }  // 入口
    };

    // ---------------------- 状態 ----------------------
    let activeCategory = 'all';
    let searchQuery = '';
    const cart = new Map(); // id -> { item, quantity }
    let orderSent = false;

    const coords = { x: 10, y: 10, z: 0.5 };

    // ---------------------- ユーティリティ ----------------------
    const JPY = n => new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(n);
    function toast(msg) {
      const wrap = document.getElementById('toasts');
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = msg;
      wrap.appendChild(el);
      setTimeout(() => { el.style.opacity = '0'; }, 2200);
      setTimeout(() => { wrap.removeChild(el); }, 2600);
    }

    function $(sel) { return document.querySelector(sel); }

    // ---------------------- 検索・タブ ----------------------
    $('#search').addEventListener('input', (e) => { searchQuery = e.target.value.trim().toLowerCase(); renderMenu(); });
    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeCategory = btn.dataset.cat;
        renderMenu();
      });
    });

    // ---------------------- 座標 ----------------------
    // $('#coord-x').addEventListener('input', e => coords.x = parseFloat(e.target.value) || 0);
    // $('#coord-y').addEventListener('input', e => coords.y = parseFloat(e.target.value) || 0);
    // $('#coord-z').addEventListener('input', e => coords.z = parseFloat(e.target.value) || 0);

    // ---------------------- お届け先（プルダウン） ----------------------
    const destSelect  = $('#destination');
    const destPreview = $('#dest-preview');
    function applyDestination(key) {
      const wp = WAYPOINTS[key];
      if (!wp) return;
      coords.x = wp.x; coords.y = wp.y; coords.z = wp.z;
      destPreview.textContent = `座標 X:${coords.x} / Y:${coords.y} / Z:${coords.z}`;
    }
    // 初期反映＆変更監視
    applyDestination(destSelect.value);
    destSelect.addEventListener('change', (e) => applyDestination(e.target.value));

    // ---------------------- メニュー描画 ----------------------
    function filterItems() {
      const norm = (s) => (s || '').toString().toLowerCase().normalize('NFKC'); // 半角全角を区別しない
      const q = norm(searchQuery);
      return ITEMS
        .filter(it => q ? true : (activeCategory === 'all' || it.category === activeCategory))
        .filter(it => !q || [norm(it.name), norm(it.description)].some(v => v.includes(q)));
    }

    function renderMenu() {
      const wrap = $('#menu');
      wrap.innerHTML = '';
      const items = filterItems();
      items.forEach(it => {
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="image"><img src="${it.image}" alt="${it.name}" loading="lazy"></div>
          <div class="body">
            <div style="display:flex;justify-content:space-between;gap:8px;align-items:flex-start">
              <div class="title">${it.name}</div>
              <div style="font-weight:700">${JPY(it.price)}</div>
            </div>
            <div class="muted">${it.description}</div>
            <div class="muted" style="display:flex;gap:8px;align-items:center">
              <span>⭐ ${it.rating.toFixed(1)}</span><span>・</span><span>${it.deliveryTime}</span>
            </div>
            <button class="btn primary add">カートに追加</button>
          </div>`;
        card.querySelector('.add').addEventListener('click', () => addToCart(it));
        wrap.appendChild(card);
      });
    }

    // ---------------------- カート ----------------------
    const cartBadge = $('#cart-badge');
    const subtotalEl = $('#subtotal');
    const orderNote = $('#order-note');
    const checkoutBtn = $('#checkout');

    function cartCount() {
      let s = 0; cart.forEach(v => s += v.quantity); return s;
    }
    function cartTotal() {
      let s = 0; cart.forEach(v => s += v.quantity * v.item.price); return s;
    }

    function syncCartBadge() {
      const c = cartCount();
      if (c > 0) { cartBadge.hidden = false; cartBadge.textContent = c; }
      else { cartBadge.hidden = true; cartBadge.textContent = '0'; }
    }

    function renderCart() {
      const list = $('#cart-list');
      list.innerHTML = '';
      if (cart.size === 0) {
        const p = document.createElement('p'); p.className = 'muted'; p.textContent = 'カートは空です。'; list.appendChild(p);
      } else {
        cart.forEach(({ item, quantity }) => {
          const li = document.createElement('div');
          li.className = 'cart-item';
          li.innerHTML = `
            <img src="${item.image}" alt="${item.name}">
            <div style="flex:1;min-width:0">
              <div style="display:flex;justify-content:space-between;gap:8px">
                <div>
                  <div style="font-weight:600" class="truncate">${item.name}</div>
                  <div class="muted">${JPY(item.price)}</div>
                </div>
                <button class="remove">削除</button>
              </div>
              <div style="margin-top:8px" class="qty">
                <button class="dec">−</button>
                <span class="count">${quantity}</span>
                <button class="inc">＋</button>
              </div>
            </div>`;
          li.querySelector('.remove').addEventListener('click', () => removeItem(item.id));
          li.querySelector('.dec').addEventListener('click', () => updateQty(item.id, Math.max(0, quantity - 1)));
          li.querySelector('.inc').addEventListener('click', () => updateQty(item.id, quantity + 1));
          list.appendChild(li);
        });
      }
      subtotalEl.textContent = JPY(cartTotal());
      checkoutBtn.disabled = (cart.size === 0) || orderSent;
      orderNote.style.display = orderSent ? 'block' : 'none';
      syncCartBadge();
    }

    function addToCart(item) {
      const v = cart.get(item.id) || { item, quantity: 0 };
      v.quantity += 1;
      cart.set(item.id, v);
      toast(`${item.name}をカートに追加しました`);
      renderCart();
    }
    function updateQty(id, qty) {
      if (!cart.has(id)) return;
      if (qty <= 0) { cart.delete(id); toast('商品をカートから削除しました'); }
      else { const v = cart.get(id); v.quantity = qty; cart.set(id, v); }
      renderCart();
    }
    function removeItem(id) { if (cart.has(id)) { cart.delete(id); toast('商品をカートから削除しました'); renderCart(); } }

    // Drawer open/close
    const drawer = $('#drawer');
    const backdrop = $('#drawer-backdrop');
    function openCart() { drawer.classList.add('open'); backdrop.classList.add('open'); renderCart(); }
    function closeCart() { drawer.classList.remove('open'); backdrop.classList.remove('open'); }
    $('#open-cart').addEventListener('click', openCart);
    $('#float-cart').addEventListener('click', openCart);
    $('#close-cart').addEventListener('click', closeCart);
    backdrop.addEventListener('click', closeCart);

    // ---------------------- WebSocket（①仕様） ----------------------
    const connDot = $('#conn-dot');
    const connText = $('#conn-text');
    const stText = $('#st-text');
    const etaText = $('#eta-text');

    let ws;
    function connectWS() {
      try { ws = new WebSocket(`ws://${location.host}/Order/ws`); } catch (e) { console.error(e); return; }
      ws.onopen = () => { connText.textContent = 'Connected'; connDot.classList.add('ok'); };
      ws.onclose = () => { connText.textContent = 'Disconnected'; connDot.classList.remove('ok'); };
      ws.onerror = () => { connText.textContent = 'Error'; connDot.classList.remove('ok'); };
      ws.onmessage = (msg) => {
        try {
          const data = JSON.parse(String(msg.data));
          const s = data && data.state;
          if (s) {
            stText.textContent = s.status ?? '-';
            etaText.textContent = (typeof s.eta === 'number') ? `${s.eta.toFixed(1)}s` : '-';
            if (orderSent && s.status === '待機中') {
              orderSent = false;
              toast('配達が完了しました。次の注文が可能です。');
              renderCart();
            }
          }
        } catch (e) {
          console.warn('WS parse error', e);
        }
      };
    }
    connectWS();

    // ---------------------- Checkout（①仕様: /register_order） ----------------------
    $('#checkout').addEventListener('click', async () => {
      if (orderSent) { toast('配達中のため次の注文は送信できません'); return; }
      // ①のAPIに合わせて3品の数量を抽出
      const qty = id => (cart.get(id)?.quantity || 0);
      const omurice = qty('omurice');
      const hamburg = qty('hamburg');
      const onigiri = qty('onigiri');
      if (omurice + hamburg + onigiri === 0) { toast('料理を選択してください'); return; }

      const payload = { omurice, hamburg, onigiri, point: { dest_id: destSelect.value }  };
      try {
        const res = await fetch('/register_order', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || 'サーバーエラー');
        orderSent = true;
        cart.clear();
        renderCart();
        toast(`注文登録完了 ID: ${data.order_id ?? '-'}`);
        closeCart();
      } catch (e) {
        console.error(e);
        toast('エラー: ' + (e.message || e));
      }
    });

    // 初期描画
    renderMenu();
    renderCart();
  </script>
</body>
</html>