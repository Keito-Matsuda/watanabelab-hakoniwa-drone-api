<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>èª¿ç†ç«¯æœ« / Delivery Cooking Dashboard</title>
  <style>
    :root{
      --bg:#f7f7f8;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#2563eb;--primary-200:#93c5fd;--border:#e5e7eb;--danger:#ef4444;--ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--text)}
    .header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .header-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;max-width:1120px;margin:0 auto;padding:12px 16px}
    .brand{font-weight:700}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .badge.default{background:#eef2ff;border-color:#c7d2fe}
    .badge.secondary{background:#f3f4f6}
    .dot{width:8px;height:8px;border-radius:999px;background:#9ca3af;display:inline-block}
    .dot.ok{background:var(--ok)}
    .muted{color:var(--muted)}

    .container{max-width:1120px;margin:1cm auto 0; padding:16px} /* ãƒ˜ãƒƒãƒ€ãƒ¼ä¸‹ã§æŠ¼ã—ã¥ã‚‰ã„å¯¾ç­– */

    .alert{margin:12px 0;padding:10px 12px;border-radius:12px;border:1px solid #fed7aa;background:#fff7ed;color:#7c2d12}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:12px;display:grid;gap:10px}
    .card-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .id{font-weight:700;word-break:break-all}
    .sub{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:14px}
    .items{display:grid;gap:6px}
    .item{display:flex;justify-content:space-between;gap:8px}
    .checklist{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .statusbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .seg{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .seg button{border:0;background:#fff;padding:8px 10px;cursor:pointer}
    .seg button.active{background:#111827;color:#fff}

    .buttons{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.ghost{background:#f3f4f6}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .empty{padding:48px 0;text-align:center;color:var(--muted)}

    /* toast */
    #toasts{position:fixed;right:16px;top:16px;z-index:60;display:grid;gap:8px}
    .toast{background:rgba(0,0,0,.85);color:#fff;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.18)}

    /* dialog */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
    .backdrop.open{display:flex}
    .dialog{background:#fff;border-radius:16px;max-width:420px;width:92vw;border:1px solid var(--border);box-shadow:0 24px 56px rgba(0,0,0,.2)}
    .dialog .hd{padding:14px 16px;border-bottom:1px solid var(--border)}
    .dialog .bd{padding:14px 16px}
    .dialog .ft{padding:14px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}

    /* top status */
    .top-status{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0 0}
    .pill{border-radius:999px;background:#eef2ff;padding:4px 10px;border:1px solid #c7d2fe;font-size:14px}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <div class="row">
        <div class="brand">èª¿ç†ç«¯æœ«</div>
        <div class="row muted" id="nowwrap">
          <span>ğŸ•’</span><span id="now">-</span>
        </div>
        <div class="row">
          <span class="badge secondary">èª¿ç†å¾…ã¡: <b id="count-waiting">0</b></span>
          <span class="badge default">èª¿ç†ä¸­: <b id="count-cooking">0</b></span>
          <span class="badge default">å—ã‘æ¸¡ã—æº–å‚™: <b id="count-ready">0</b></span>
        </div>
      </div>
      <div class="row">
        <span id="conn-dot" class="dot"></span>
        <span id="conn-text" class="muted">Connecting...</span>
      </div>
    </div>
  </div>

  <div class="container">
    <div id="net-alert" class="alert" style="display:none">æ¥ç¶šãŒä¸å®‰å®šã§ã™ã€‚æ“ä½œã¯å†æ¥ç¶šå¾Œã«ãŠè©¦ã—ãã ã•ã„ã€‚</div>

    <div class="top-status">
      <span class="pill">ãƒ‰ãƒ­ãƒ¼ãƒ³çŠ¶æ…‹: <b id="drone-status">-</b></span>
      <span class="pill">æ®‹ã‚Šã®ç›®å®‰å¾…ã¡æ™‚é–“: <b id="drone-eta">-</b></span>
    </div>

    <div id="list" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty" style="display:none">æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>
  </div>

  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Confirm Dialog -->
  <div id="dlg-backdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="dlg-title">
    <div class="dialog">
      <div class="hd"><b id="dlg-title">ãƒ‰ãƒ­ãƒ¼ãƒ³ç™ºé€²ç¢ºèª</b></div>
      <div class="bd">
        <div id="dlg-desc" class="muted">æ³¨æ–‡ <span id="dlg-order-id">-</span> ã®ãƒ‰ãƒ­ãƒ¼ãƒ³ã‚’ç™ºé€²ã•ã›ã¾ã™ã‹ï¼Ÿ<br />ç™ºé€²å¾Œã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã¾ã›ã‚“ã€‚</div>
      </div>
      <div class="ft">
        <button class="btn" id="dlg-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn primary" id="dlg-ok">ç™ºé€²ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    // ------- å®šæ•°ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆorderUI.htmlã¨åŒä¸€ã®å“ç›®/ä¾¡æ ¼ï¼‰
    const MENU = {
      w1:{name:'ãµã‚ã¨ã‚ã‚ªãƒ ãƒ©ã‚¤ã‚¹', price:500},
      w2:{name:'è‚‰åšãƒãƒ³ãƒãƒ¼ã‚°å¼å½“', price:600},
      w3:{name:'ã‚µã‚¯ãƒ—ãƒªã‚¨ãƒ“ãƒ•ãƒ©ã‚¤å¼å½“', price:700},
      j1:{name:'å¹•ã®å†…å¼å½“', price:600},
      j2:{name:'è±šã®ç”Ÿå§œç„¼ãå¼å½“', price:500},
      j3:{name:'é¯–ã®å‘³å™Œç…®å¼å½“', price:700},
      c1:{name:'æ²¹æ·‹é¶å¼å½“', price:700},
      c2:{name:'éº»å©†è±†è…å¼å½“', price:500},
      c3:{name:'å›é‹è‚‰å¼å½“', price:600},
    };

    const DEST_LABEL = { D8:'8éš', D7:'7éš', D6:'6éš', D5:'5éš', P8:'ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹' };
    const JPY = n => new Intl.NumberFormat('ja-JP',{style:'currency', currency:'JPY'}).format(n||0);

    // ------- ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹
    /**
     * ordersMap[id] = {
     *   server: { id, w1..c3, point:{dest_id} },
     *   status: 'waiting'|'cooking'|'ready',
     *   cookingCompleted: boolean,
     *   packagingCompleted: boolean,
     *   droneStatus: 'preparing'|'flying'|'delivered'|undefined,
     *   createdAt: number (ms)
     * }
     */
    const ordersMap = Object.create(null);

    // ------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    const $ = sel => document.querySelector(sel);
    function toast(msg){
      const wrap = $('#toasts');
      const el = document.createElement('div');
      el.className='toast'; el.textContent=msg; wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; },2200);
      setTimeout(()=>{ if(el.parentNode){ el.parentNode.removeChild(el); } },2600); // è¦ªå­˜åœ¨ã‚¬ãƒ¼ãƒ‰
    }

    function itemsFromServerOrder(o){
      const items = [];
      Object.keys(MENU).forEach(k=>{
        const qty = parseInt(o[k]||0,10) || 0;
        if(qty>0){ items.push({ id:k, name:MENU[k].name, price:MENU[k].price, qty }); }
      });
      return items;
    }

    function totals(items){
      return items.reduce((s,it)=>s + it.price*it.qty, 0);
    }

    function destOf(o){
      const id = o?.point?.dest_id; if(!id) return '-';
      return `${DEST_LABEL[id]||id} (${id})`;
    }

    function statusCounts(){
      let waiting=0,cooking=0,ready=0; 
      Object.values(ordersMap).forEach(v=>{
        if(v.status==='waiting') waiting++; else if(v.status==='cooking') cooking++; else if(v.status==='ready') ready++;
      });
      return {waiting,cooking,ready};
    }

    function updateHeaderCounts(){
      const c = statusCounts();
      $('#count-waiting').textContent = c.waiting;
      $('#count-cooking').textContent = c.cooking;
      $('#count-ready').textContent   = c.ready;
    }

    function render(){
      const list = $('#list'); list.innerHTML='';
      const entries = Object.values(ordersMap).sort((a,b)=>a.createdAt-b.createdAt);
      $('#empty').style.display = entries.length===0 ? 'block' : 'none';
      entries.forEach(entry=> list.appendChild(renderCard(entry)) );
      updateHeaderCounts();
    }

    function renderCard(entry){
      const { server:o, status, cookingCompleted, packagingCompleted } = entry;
      const items = itemsFromServerOrder(o);
      const total = totals(items);
      const el = document.createElement('article'); el.className='card'; el.id = `card_${o.id}`;

      // header
      const head = document.createElement('div'); head.className='card-head';
      const left = document.createElement('div');
      left.innerHTML = `<div class="id">${o.id}</div>
        <div class="sub"> <span>ãŠå±Šã‘å…ˆ: ${destOf(o)}</span> <span>ãƒ»</span> <span>${new Date(entry.createdAt).toLocaleTimeString('ja-JP')}</span> </div>`;
      const right = document.createElement('div'); right.className='statusbar';
      const seg = document.createElement('div'); seg.className='seg';
      ['waiting','cooking','ready'].forEach(k=>{
        const btn = document.createElement('button'); btn.textContent = (k==='waiting'?'èª¿ç†å¾…ã¡':k==='cooking'?'èª¿ç†ä¸­':'å—ã‘æ¸¡ã—æº–å‚™');
        if(status===k) btn.classList.add('active');
        btn.addEventListener('click',()=>{ entry.status=k; toast(`${o.id} ã‚’${btn.textContent}ã«æ›´æ–°ã—ã¾ã—ãŸ`); render(); });
        seg.appendChild(btn);
      });
      right.appendChild(seg);
      head.appendChild(left); head.appendChild(right);

      // items
      const itemsWrap = document.createElement('div'); itemsWrap.className='items';
      items.forEach(it=>{
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `<div>${it.name} Ã— ${it.qty}</div><div>${JPY(it.price*it.qty)}</div>`;
        itemsWrap.appendChild(row);
      });
      const totalRow = document.createElement('div'); totalRow.className='item'; totalRow.innerHTML = `<div style="font-weight:700">å°è¨ˆ</div><div style="font-weight:700">${JPY(total)}</div>`;
      itemsWrap.appendChild(totalRow);

      // actionsï¼ˆå…ˆã«ç”¨æ„ã—ã¦ãƒã‚§ãƒƒã‚¯ã‹ã‚‰å‚ç…§ï¼‰
      const actions = document.createElement('div'); actions.className='buttons';
      const btnStart = document.createElement('button'); btnStart.className='btn ghost'; btnStart.textContent='èª¿ç†é–‹å§‹';
      btnStart.addEventListener('click',()=>{ entry.status='cooking'; toast(`${o.id} ã®èª¿ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸ`); render(); });

      const btnLaunch = document.createElement('button'); btnLaunch.className='btn primary'; btnLaunch.textContent='ãƒ‰ãƒ­ãƒ¼ãƒ³ç™ºé€²';
      btnLaunch.disabled = !entry.packagingCompleted; // æ¢±åŒ…å®Œäº†ã§æœ‰åŠ¹
      btnLaunch.addEventListener('click',()=> openConfirm(o.id));

      actions.appendChild(btnStart); actions.appendChild(btnLaunch);

      // checklist
      const checklist = document.createElement('div'); checklist.className='checklist';
      const c1 = document.createElement('label');
      const c1input = document.createElement('input'); c1input.type='checkbox'; c1input.checked = !!cookingCompleted;
      c1.appendChild(c1input); c1.append(' èª¿ç†å®Œäº†');
      const c2 = document.createElement('label');
      const c2input = document.createElement('input'); c2input.type='checkbox'; c2input.checked = !!packagingCompleted;
      c2.appendChild(c2input); c2.append(' æ¢±åŒ…å®Œäº†');

      c1input.addEventListener('change',e=>{
        entry.cookingCompleted = !!e.target.checked;
        render(); // è¡¨ç¤ºã®åŒæœŸãŒå¿…è¦ãªã‚‰
      });
      c2input.addEventListener('change',e=>{
        entry.packagingCompleted = !!e.target.checked;
        btnLaunch.disabled = !entry.packagingCompleted; // ç™ºé€²ãƒœã‚¿ãƒ³ã‚’å³æ™‚åæ˜ 
      });

      checklist.appendChild(c1); checklist.appendChild(c2);

      el.appendChild(head); el.appendChild(itemsWrap); el.appendChild(checklist); el.appendChild(actions);
      return el;
    }

    // ------- Confirm dialog & launch
    let pendingOrderId = null;
    function openConfirm(orderId){
      pendingOrderId = orderId; $('#dlg-order-id').textContent = orderId; $('#dlg-backdrop').classList.add('open');
    }
    function closeConfirm(){ $('#dlg-backdrop').classList.remove('open'); pendingOrderId=null; }
    $('#dlg-cancel').addEventListener('click', closeConfirm);
    $('#dlg-ok').addEventListener('click', async ()=>{
      if(!pendingOrderId) return;
      try{
        const res = await fetch('/start_delivery',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ order_id: pendingOrderId }) });
        if(!res.ok) throw new Error('é…é”é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
        const entry = ordersMap[pendingOrderId];
        if(entry){ entry.droneStatus='preparing'; }
        toast(`${pendingOrderId} ã®ãƒ‰ãƒ­ãƒ¼ãƒ³ãŒç™ºé€²ã—ã¾ã—ãŸ`);
      }catch(e){
        toast('ã‚¨ãƒ©ãƒ¼: '+(e.message||e));
      }finally{ closeConfirm(); render(); }
    });

    // ------- WebSocketæ¥ç¶šï¼ˆã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ï¼†ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    const connDot = $('#conn-dot'); const connText = $('#conn-text');
    const netAlert = $('#net-alert');
    const droneStatusEl = $('#drone-status'); const droneEtaEl = $('#drone-eta');

    let ws = null; let reconnectAttempt = 0;
    const WS_PATHS = ['/delivery/ws','/Delivery/ws','/ws']; // å„ªå…ˆé †
    const currentWsPath = () => WS_PATHS[reconnectAttempt % WS_PATHS.length];

    // æç”»ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ï¼ˆWSé«˜é »åº¦æ›´æ–°å¯¾ç­–ï¼‰
    let renderTimer = null;
    function scheduleRender(delay=150){
      if(renderTimer) return;
      renderTimer = setTimeout(()=>{ renderTimer=null; render(); }, delay);
    }

    function connectWS(){
      const proto = (location.protocol==='https:') ? 'wss' : 'ws';
      const path = currentWsPath();
      try{
        ws = new WebSocket(`${proto}://${location.host}${path}`);
      }catch(e){
        scheduleReconnect();
        return;
      }

      ws.onopen = ()=>{
        connDot.classList.add('ok'); connText.textContent='æ¥ç¶šä¸­'; netAlert.style.display='none';
        reconnectAttempt = 0; // æˆåŠŸã—ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
      };
      ws.onclose = ()=>{
        connDot.classList.remove('ok'); connText.textContent='å†æ¥ç¶šä¸­...'; netAlert.style.display='block';
        scheduleReconnect();
      };
      ws.onerror = ()=>{
        connDot.classList.remove('ok'); connText.textContent='ã‚¨ãƒ©ãƒ¼'; netAlert.style.display='block';
      };
      ws.onmessage = evt => {
        try{
          const data = JSON.parse(String(evt.data));
          const s = data?.state || {};

          // ãƒ‰ãƒ­ãƒ¼ãƒ³çŠ¶æ…‹ã¯ç›´æ¥æ›´æ–°ï¼ˆå…¨ä½“å†æç”»ã—ãªã„ï¼‰
          droneStatusEl.textContent = (s.status ?? '-') + '';
          droneEtaEl.textContent = (typeof s.eta==='number') ? (s.eta.toFixed(1)+'s') : '-';

          // æ–°è¦æ³¨æ–‡/æ¶ˆæ»…ã‚’å·®åˆ†åæ˜ ï¼ˆorders / order ä¸¡å¯¾å¿œï¼‰
          const incoming = Array.isArray(data?.orders) ? data.orders :
                           (Array.isArray(data?.order) ? data.order : []);
          const liveIds = new Set(incoming.map(o=>o.id).filter(Boolean));

          let changed = false;

          // è¿½åŠ ãƒ»æ›´æ–°
          incoming.forEach(o=>{
            if(!o?.id) return;
            const cur = ordersMap[o.id];
            if(!cur){
              ordersMap[o.id] = {
                server:o,
                status:'waiting',
                cookingCompleted:false,
                packagingCompleted:false,
                droneStatus:undefined,
                createdAt:Date.now()
              };
              changed = true;
            }else{
              const prev = cur.server || {};
              const diff =
                prev.w1!==o.w1 || prev.w2!==o.w2 || prev.w3!==o.w3 ||
                prev.j1!==o.j1 || prev.j2!==o.j2 || prev.j3!==o.j3 ||
                prev.c1!==o.c1 || prev.c2!==o.c2 || prev.c3!==o.c3 ||
                (prev.point?.dest_id)!==(o.point?.dest_id);
              if(diff){ cur.server = o; changed = true; }
            }
          });

          // æ¶ˆæ»…ï¼ˆé…é”å®Œäº†ï¼‰
          Object.keys(ordersMap).forEach(id=>{
            if(!liveIds.has(id)){
              const wasFlying = ordersMap[id].droneStatus==='preparing' || ordersMap[id].droneStatus==='flying';
              if(wasFlying){ toast(`${id} ã®é…é”ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`); }
              delete ordersMap[id];
              changed = true;
            }
          });

          if(changed) scheduleRender(); // å·®åˆ†ãŒã‚ã‚‹ã¨ãã®ã¿æç”»
        }catch(e){ console.warn('WS parse error', e); }
      };
    }

    function scheduleReconnect(){
      reconnectAttempt++;
      const timeout = Math.min(10000, 1000 * Math.pow(2, reconnectAttempt));
      setTimeout(connectWS, timeout);
    }

    connectWS();

    // ------- æ™‚åˆ»è¡¨ç¤º
    function tick(){ $('#now').textContent = new Date().toLocaleTimeString('ja-JP'); }
    tick(); setInterval(tick, 1000);

  </script>
</body>
</html>
