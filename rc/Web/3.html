<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>調理端末 / Delivery Cooking Dashboard</title>
  <style>
    :root{
      --bg:#f7f7f8;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#2563eb;--primary-200:#93c5fd;--border:#e5e7eb;--danger:#ef4444;--ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--text)}
    .header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .header-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;max-width:1120px;margin:0 auto;padding:12px 16px}
    .brand{font-weight:700}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .badge.default{background:#eef2ff;border-color:#c7d2fe}
    .badge.secondary{background:#f3f4f6}
    .dot{width:8px;height:8px;border-radius:999px;background:#9ca3af;display:inline-block}
    .dot.ok{background:var(--ok)}
    .muted{color:var(--muted)}

    .container{max-width:1120px;margin:1cm auto 0; padding:16px}
    .alert{margin:12px 0;padding:10px 12px;border-radius:12px;border:1px solid #fed7aa;background:#fff7ed;color:#7c2d12}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:12px;display:grid;gap:10px;transition: background-color .3s, opacity .3s;}
    .card.delivering{background-color: #f3f4f6; opacity: .8;}
    .card.delivering .seg button {cursor: not-allowed;}

    .card-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .id{font-weight:700;word-break:break-all}
    .sub{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:14px}
    .items{display:grid;gap:6px; font-size: 15px; padding: 8px 0;}
    .item{display:flex;justify-content:space-between;gap:8px}
    .statusbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .seg{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .seg button{border:0;background:#fff;padding:8px 10px;cursor:pointer}
    .seg button:disabled{background-color: #f9fafb; color: var(--muted); cursor: not-allowed;}
    .seg button.active{background:#111827;color:#fff}

    .buttons{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.ghost{background:#f3f4f6}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .empty{padding:48px 0;text-align:center;color:var(--muted)}
    
    #toasts{position:fixed;right:16px;top:16px;z-index:60;display:grid;gap:8px}
    .toast{background:rgba(0,0,0,.85);color:#fff;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.18)}
    
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
    .backdrop.open{display:flex}
    .dialog{background:#fff;border-radius:16px;max-width:520px;width:92vw;border:1px solid var(--border);box-shadow:0 24px 56px rgba(0,0,0,.2)}
    .dialog .hd{padding:14px 16px;border-bottom:1px solid var(--border); display: flex; justify-content: space-between; align-items: center;}
    .dialog .bd{padding:14px 16px}
    .dialog .ft{padding:14px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
    .hist-table{width:100%;border-collapse:collapse;font-size:14px}
    .hist-table th,.hist-table td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left;vertical-align:top}
    .hist-table th{background:#f9fafb}
    
    .top-status{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0 0}
    .pill{border-radius:999px;background:#eef2ff;padding:4px 10px;border:1px solid #c7d2fe;font-size:14px}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <div class="row">
        <div class="brand">調理端末</div>
        <div class="row muted" id="nowwrap"><span>🕒</span><span id="now">-</span></div>
        <div class="row">
          <span class="badge secondary">調理待ち: <b id="count-waiting">0</b></span>
          <span class="badge default">調理中: <b id="count-cooking">0</b></span>
          <span class="badge default">受け渡し準備完了: <b id="count-ready">0</b></span>
          <button class="btn" id="btn-history" title="配達完了の履歴を表示">完了履歴</button>
        </div>
      </div>
      <div class="row">
        <span id="conn-dot" class="dot"></span>
        <span id="conn-text" class="muted">Connecting...</span>
      </div>
    </div>
  </div>

  <div class="container">
    <div id="net-alert" class="alert" style="display:none">接続が不安定です。操作は再接続後にお試しください。</div>
    <div class="top-status">
      <span class="pill">ドローン状態: <b id="drone-status">-</b></span>
      <span class="pill">配達完了までの目安: <b id="drone-eta">-</b></span>
    </div>
    <div id="list" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty" style="display:none">注文はありません</div>
  </div>

  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <div id="dlg-backdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="dlg-title">
    <div class="dialog">
      <div class="hd"><b id="dlg-title">ドローン発進確認</b></div>
      <div class="bd">
        <div id="dlg-desc" class="muted">注文 <span id="dlg-order-id">-</span> のドローンを発進させますか？<br />発進後はキャンセルできません。</div>
      </div>
      <div class="ft">
        <button class="btn" id="dlg-cancel">キャンセル</button>
        <button class="btn primary" id="dlg-ok">発進する</button>
      </div>
    </div>
  </div>

  <div id="hist-backdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="hist-title">
    <div class="dialog">
      <div class="hd">
        <b id="hist-title">完了履歴</b>
      </div>
      <div class="bd">
        <table class="hist-table">
          <thead><tr><th>完了時刻</th><th>注文ID</th><th>お届け先</th></tr></thead>
          <tbody id="hist-tbody"></tbody>
        </table>
        <div id="hist-empty" class="muted" style="padding:8px 4px;">履歴はありません</div>
      </div>
      <div class="ft"><button class="btn" id="hist-close">閉じる</button></div>
    </div>
  </div>

  <script>
    // ------- ローカル状態
    const ordersMap = Object.create(null);
    const history = [];
    let deliveryInProgress = false; // グローバルな配達中フラグ

    // ------- ユーティリティ
    const $ = sel => document.querySelector(sel);
    function toast(msg){
      const wrap = $('#toasts');
      const el = document.createElement('div');
      el.className='toast'; el.textContent=msg; wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; }, 2200);
      setTimeout(()=>{ if(el.parentNode) el.parentNode.removeChild(el); }, 2600);
    }
    const destOf = o => o?.point?.dest_id || '-';

    function statusCounts(){
      let waiting=0, cooking=0, ready=0; 
      Object.values(ordersMap).forEach(v=>{
        if(v.status==='waiting') waiting++; else if(v.status==='cooking') cooking++; else if(v.status==='ready') ready++;
      });
      return {waiting, cooking, ready};
    }

    function updateHeaderCounts(){
      const c = statusCounts();
      $('#count-waiting').textContent = c.waiting;
      $('#count-cooking').textContent = c.cooking;
      $('#count-ready').textContent   = c.ready;
    }
    
    // サーバーに注文ステータスを通知
    function notifyServer(orderId, status) {
      fetch('/update_order_status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ order_id: orderId, status: status })
      }).catch(e => console.error("Status update failed:", e));
    }
    
    // ------- UI描画
    function render(){
      const list = $('#list'); list.innerHTML='';
      const entries = Object.values(ordersMap).sort((a,b) => a.createdAt - b.createdAt);
      $('#empty').style.display = entries.length === 0 ? 'block' : 'none';
      
      deliveryInProgress = entries.some(e => e.isDelivering); // 配達中フラグを更新
      
      entries.forEach(entry => list.appendChild(renderCard(entry)));
      updateHeaderCounts();
    }

    function renderCard(entry){
      const { server:o, status, isDelivering } = entry;
      const el = document.createElement('article'); 
      el.className='card'; 
      el.id = `card_${o.id}`;
      if(isDelivering) el.classList.add('delivering');

      const head = document.createElement('div'); head.className='card-head';
      head.innerHTML = `<div><div class="id">${o.id}</div><div class="sub"><span>お届け先: ${destOf(o)}</span> <span>・</span> <span>${new Date(entry.createdAt).toLocaleTimeString('ja-JP')}</span></div></div>`;
      
      const seg = document.createElement('div'); seg.className='seg';
      ['waiting','cooking','ready'].forEach(k => {
        const btn = document.createElement('button');
        btn.textContent = (k==='waiting'?'調理待ち':k==='cooking'?'調理中':'準備完了');
        if(status===k) btn.classList.add('active');
        
        if (isDelivering || (status === 'cooking' && k === 'waiting') || (status === 'ready' && (k === 'waiting' || k === 'cooking'))) {
          btn.disabled = true;
        }

        btn.addEventListener('click', () => {
          entry.status = k;
          const serverStatusMap = { cooking: 'cooking', ready: 'ready' };
          if(serverStatusMap[k]) notifyServer(o.id, serverStatusMap[k]);
          toast(`${o.id} を${btn.textContent}に更新しました`);
          render();
        });
        seg.appendChild(btn);
      });
      head.appendChild(seg);

      const itemsWrap = document.createElement('div'); itemsWrap.className='items';
      o.orders.forEach(it => {
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `<div>${it.name} × ${it.qty}</div>`;
        itemsWrap.appendChild(row);
      });

      const actions = document.createElement('div'); actions.className='buttons';
      const btnStart = document.createElement('button'); 
      btnStart.className='btn ghost'; 
      btnStart.textContent='調理開始';
      btnStart.disabled = isDelivering || status !== 'waiting';
      btnStart.addEventListener('click', () => { 
        entry.status='cooking'; 
        notifyServer(o.id, 'cooking');
        toast(`${o.id} の調理を開始しました`); 
        render(); 
      });

      const btnLaunch = document.createElement('button');
      btnLaunch.className='btn primary';
      btnLaunch.textContent = isDelivering ? '配達中...' : 'ドローン発進';
      btnLaunch.disabled = (status !== 'ready') || deliveryInProgress;
      btnLaunch.addEventListener('click', () => openConfirm(o.id));
      
      actions.appendChild(btnStart);
      actions.appendChild(btnLaunch);

      el.appendChild(head);
      el.appendChild(itemsWrap);
      el.appendChild(actions);
      return el;
    }

    // ------- Dialogs & History
    let pendingOrderId = null;
    function openConfirm(orderId){ pendingOrderId = orderId; $('#dlg-order-id').textContent = orderId; $('#dlg-backdrop').classList.add('open'); }
    function closeConfirm(){ $('#dlg-backdrop').classList.remove('open'); pendingOrderId=null; }
    $('#dlg-cancel').addEventListener('click', closeConfirm);
    $('#dlg-ok').addEventListener('click', async () => {
      if(!pendingOrderId) return;
      try {
        await fetch('/start_delivery',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ order_id: pendingOrderId }) });
        const entry = ordersMap[pendingOrderId];
        if(entry){ entry.isDelivering = true; }
        notifyServer(pendingOrderId, 'delivering');
        toast(`${pendingOrderId} のドローンが発進しました`);
      } catch(e) {
        toast('エラー: '+(e.message||e));
      } finally { closeConfirm(); render(); }
    });

    function openHistory(){
      histTbody.innerHTML = '';
      if(history.length === 0) {
        $('#hist-empty').style.display = 'block';
      } else {
        $('#hist-empty').style.display = 'none';
        history.slice().reverse().forEach(h => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${new Date(h.finishedAt).toLocaleString('ja-JP')}</td><td>${h.id}</td><td>${h.dest}</td>`;
          histTbody.appendChild(tr);
        });
      }
      $('#hist-backdrop').classList.add('open');
    }
    $('#btn-history').addEventListener('click', openHistory);
    $('#hist-close').addEventListener('click', () => $('#hist-backdrop').classList.remove('open'));

    // ------- WebSocket
    const connDot = $('#conn-dot'), connText = $('#conn-text'), netAlert = $('#net-alert');
    const droneStatusEl = $('#drone-status'), droneEtaEl = $('#drone-eta');
    let ws = null, reconnectAttempt = 0, renderTimer = null;
    const WS_PATHS = ['/delivery/ws','/Delivery/ws','/ws'];

    function scheduleRender(delay=150){
      if(renderTimer) return;
      renderTimer = setTimeout(()=>{ renderTimer=null; render(); }, delay);
    }

    function connectWS(){
      try{ ws = new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}${WS_PATHS[reconnectAttempt % WS_PATHS.length]}`); } 
      catch(e){ scheduleReconnect(); return; }

      ws.onopen = () => { connDot.classList.add('ok'); connText.textContent='接続中'; netAlert.style.display='none'; reconnectAttempt = 0; };
      ws.onclose = () => { connDot.classList.remove('ok'); connText.textContent='再接続中...'; netAlert.style.display='block'; scheduleReconnect(); };
      ws.onerror = () => { connDot.classList.remove('ok'); connText.textContent='エラー'; netAlert.style.display='block'; };
      ws.onmessage = evt => {
        try{
          const data = JSON.parse(String(evt.data));
          const s = data?.state || {};
          let etaText = '-';
          if(typeof s.eta === 'number'){
            const roundedEta = Math.round(s.eta / 5) * 5 + 10;
            etaText = `約${roundedEta}秒`;
          }
          droneStatusEl.textContent = (s.status ?? '-');
          droneEtaEl.textContent = etaText;

          const incomingOrders = Array.isArray(data?.order) ? data.order : [];
          const liveIds = new Set(incomingOrders.map(o => o.id).filter(Boolean));
          let changed = false;

          incomingOrders.forEach(o => {
            if(!o?.id) return;
            const cur = ordersMap[o.id];
            const serverStatus = (o.status || '').toLowerCase();

            if(!cur){
              const newEntry = {
                server: o, status: 'waiting',
                isDelivering: false, createdAt: Date.now()
              };
              if (serverStatus === 'cooking' || serverStatus === 'cooked') { newEntry.status = 'cooking'; }
              if (serverStatus === 'ready' || serverStatus === 'delivering') { newEntry.status = 'ready'; }
              if (serverStatus === 'delivering') { newEntry.isDelivering = true; }
              ordersMap[o.id] = newEntry;
              changed = true;
            } else {
              cur.server = o; // サーバーからの最新情報で上書き
              const uiStatus = serverStatus === 'new' ? 'waiting' : (serverStatus.includes('cook') ? 'cooking' : 'ready');
              if (cur.status !== uiStatus) { cur.status = uiStatus; changed = true; }
              const isDeliveringNow = serverStatus === 'delivering';
              if (cur.isDelivering !== isDeliveringNow) { cur.isDelivering = isDeliveringNow; changed = true; }
            }
          });

          Object.keys(ordersMap).forEach(id => {
            if(!liveIds.has(id)){
              const cur = ordersMap[id];
              if(cur){
                history.push({ id, dest: destOf(cur.server), finishedAt: Date.now() });
                if(cur.isDelivering) toast(`${id} の配達が完了しました。`);
              }
              delete ordersMap[id];
              changed = true;
            }
          });

          if(changed) scheduleRender();
        } catch(e) { console.warn('WS parse error', e); }
      };
    }

    function scheduleReconnect(){
      reconnectAttempt++;
      setTimeout(connectWS, Math.min(10000, 1000 * Math.pow(2, reconnectAttempt)));
    }

    connectWS();
    const histTbody = $('#hist-tbody'), histEmpty = $('#hist-empty'); // Global scope for dialogs
    function tick(){ $('#now').textContent = new Date().toLocaleTimeString('ja-JP'); }
    tick(); setInterval(tick, 1000);
  </script>
</body>
</html>
